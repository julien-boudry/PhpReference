# Standalone Function Discovery

## Overview

This feature enables PhpReference to discover and document functions declared outside of classes (standalone functions) within a given namespace.

## Architecture

### New Component: `FunctionDiscovery`

**File**: `src/FunctionDiscovery.php`

This service uses `nikic/php-parser` to statically analyze PHP files and extract function declarations without executing them.

**Main Methods**:
- `getFunctionsInNamespace(string $namespace): array<string>` - Discovers all functions in a given namespace
- `getPhpFilesInNamespace(string $namespace): array<string>` - Retrieves all PHP files in the namespace via Composer's PSR-4 mappings
- `scanDirectory(string $directory): array<string>` - Recursively scans a directory to find PHP files

**AST Visitor**: `FunctionVisitor`
- Traverses the abstract syntax tree (AST) generated by `nikic/php-parser`
- Identifies `Node\Stmt\Function_` nodes (function declarations)
- Constructs fully qualified names with namespaces

## Changes Made

### `CodeIndex.php`
- **New Property**: `public protected(set) array $functions = []` - Stores all discovered `FunctionWrapper` instances
- **Discovery Process**:
  1. Class discovery (existing)
  2. **New**: Function discovery via `FunctionDiscovery::getFunctionsInNamespace()`
  3. Creation of `FunctionWrapper` for each found function
  4. Grouping by namespace with classes
  5. Creation of `NamespaceWrapper` with both classes AND functions

### `NamespaceWrapper.php`
- **New Property**: `public readonly array $functions = []` - Stores functions in the namespace
- Functions are now separated from classes when creating the wrapper

### `ReflectionWrapper.php`
- **`ReflectionFunction` Support**: Handles PHPDoc context for standalone functions
- Manual `Context` creation for functions (since `phpDocumentor\Reflection\Types\ContextFactory` doesn't natively support them)

## How It Works

### Discovery Flow

```
Namespace
    ↓
FunctionDiscovery::getFunctionsInNamespace()
    ↓
Read composer.json (autoload + autoload-dev)
    ↓
PSR-4 Mapping → File Paths
    ↓
Recursive Directory Scan
    ↓
For Each PHP File:
    ↓
Parser → AST (nikic/php-parser)
    ↓
FunctionVisitor → Function Extraction
    ↓
Build Fully Qualified Name (namespace + name)
    ↓
List of Found Functions
    ↓
CodeIndex → Create FunctionWrapper
    ↓
Add to Namespaces and Global Index
```

### Usage Example

```php
use JulienBoudry\PhpReference\FunctionDiscovery;

// Discover functions in a namespace
$functions = FunctionDiscovery::getFunctionsInNamespace('MyApp\\Helpers');

// Result: ['MyApp\\Helpers\\formatDate', 'MyApp\\Helpers\\sanitizeInput', ...]
```

### Integration in CodeIndex

```php
$codeIndex = new CodeIndex('MyApp');

// Functions are automatically discovered and accessible
$allFunctions = $codeIndex->functions; // array<string, FunctionWrapper>

// By namespace
$namespace = $codeIndex->namespaces['MyApp\\Helpers'];
$namespaceFunctions = $namespace->functions; // array<string, FunctionWrapper>
```

## Dependencies

- **`nikic/php-parser`**: ^5.6 - PHP file parsing into AST (already present via PHPStan)
- Compatible with PHP 8.4+ (property hooks, asymmetric visibility)

## Tests

### Unit Tests
- `tests/Unit/FunctionDiscoveryTest.php` - Function discovery tests
- Test fixtures: `tests/Fixtures/TestFunctions.php`

### Integration Tests
- `tests/Feature/CodeIndexTest.php` - Verification that functions are properly integrated into the index

### Coverage
- ✅ Function discovery in a namespace
- ✅ Handling empty namespaces (without functions)
- ✅ PSR-4 mapping support (autoload and autoload-dev)
- ✅ `FunctionWrapper` creation with PHPDoc
- ✅ Integration into `NamespaceWrapper`
- ✅ Correct parsing of function declarations
- ✅ Function page generation via `FunctionPageWriter`
- ✅ Function inclusion in API summary pages
- ✅ Cross-reference linking via `UrlLinker`

## Known Limitations

1. **Conditional Functions**: Functions declared conditionally (within if/switch statements) are detected in the AST but may not be loaded in PHP
2. **Autoloading**: Functions must be in files accessible via Composer's PSR-4 mappings
3. **Performance**: Parsing all files can be expensive on very large projects (implicitly cached by the unique instantiation of `CodeIndex`)

## Output Structure

Functions are integrated into the documentation output alongside classes:

```
output/
├── readme.md                          # API summary with function tables
└── ref/
    └── Namespace/
        ├── ClassName/
        │   ├── class_ClassName.md
        │   ├── methodName.md
        │   └── propertyName.md
        ├── functionName.md            # Standalone function pages
        └── SubNamespace/
            └── ...
```

Each function gets its own Markdown page at the namespace level, similar to how classes get their own directory.

### FunctionPageWriter

**File**: `src/Writer/FunctionPageWriter.php`

Generates Markdown documentation pages for standalone functions using the `function_page.latte` template.

**Features**:
- Full function signature with parameters and return type
- PHPDoc description and tags
- Parameter documentation with types and descriptions
- Return type documentation
- Exception documentation (@throws tags)
- Cross-references via `UrlLinker`

### Integration in API Summary

Functions are now included in the API summary page (`readme.md`):
- Listed in their respective namespace sections
- Displayed in dedicated function tables alongside classes and enums
- Only functions marked as part of the public API are included (based on `PublicApiDefinitionInterface`)
- Generated via `NamespacePageInput` which organizes both classes and functions by namespace

### URL Linking

The `UrlLinker` class works seamlessly with functions:
- `FunctionWrapper` implements `WritableInterface` (required for URL linking)
- Functions can be linked from any documentation page
- Relative paths are automatically calculated based on the function's location in the output structure
- Cross-references in parameter types and return types are automatically generated


